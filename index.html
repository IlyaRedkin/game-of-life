<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Game of life</title>
  <link rel="stylesheet" href="index.css">
</head>
<body>
<h1>Game of Life</h1>
<script type="text/javascript" src="utils.js"></script>
<script type="text/javascript" src="figures/glider.js"></script>
<script type="text/javascript" src="figures/planner.js"></script>
<script type="text/javascript" src="index.js"></script>
<script type="text/javascript" src="canvas.js"></script>
<script>
  // defaults
  let widthPx = 500;
  let heightPx = 500;
  let cellSizePx = 10;
  let intervalTime = 10;
</script>
<script>
  window.onload = function () {
    initPage();
  };

  let scrollContainer
  let canvasContext
  let scrollEl

  let from = {x: 0, y: 0}
  let to = {x: widthPx, y: heightPx}

  function updateScrollContainer() {
    scrollContainer = document.querySelector("#scroll-container");
  }

  function updateCanvasContext() {
    canvasContext = getCanvasContext({width: scrollContainer?.clientWidth, height: scrollContainer?.clientHeight})
  }

  function updateFieldArea() {
    scrollEl = document.querySelector("#field-area");
    scrollEl.style.width = `${widthPx}px`
    scrollEl.style.height = `${heightPx}px`

    from = {x: 0, y: 0};
    to = {x: widthPx, y: heightPx}

    canvasContext.clearRect(0, 0, scrollContainer?.clientWidth, scrollContainer?.clientHeight)
  }

  function initPage() {
    updateScrollContainer()
    updateCanvasContext()
    updateFieldArea()

    scrollContainer.addEventListener("scroll", (event) => {
      const {scrollTop, scrollLeft, clientWidth, clientHeight} = event.target || {};
      from = {x: scrollLeft, y: scrollTop};
      to = {x: scrollLeft + clientWidth, y: scrollTop + clientHeight};
    });
  }
</script>
<script>
  let intervalId
  let count = 0
  let cycleAliveMap
  let pointsToCheck
  const getCycles = (data) => {
    cycleAliveMap = data
    pointsToCheck = getPointsToCheck(cycleAliveMap)
    intervalId = setInterval(() => {
      const {
        newAliveMap,
        nextCyclePointsToCheck
      } = getCycle({
        pointsToCheck,
        maxCellCountHeight: heightPx / cellSizePx,
        maxCellCountWidth: widthPx / cellSizePx,
        aliveMap: cycleAliveMap
      })
      pointsToCheck = nextCyclePointsToCheck
      cycleAliveMap = newAliveMap
      console.log('nextCyclePointsToCheck', nextCyclePointsToCheck.length)
      count += 1

      updateGrid({
        from,
        to,
        context: canvasContext,
        dataMap: cycleAliveMap
      });
    }, intervalTime)
  }

  const startGame = () => {
    getCycles(plannerMap)
    // getCycles(gliderMap)
  }
  const stopGame = () => {
    clearInterval(intervalId)
  }

  const updateField = () => {
    updateScrollContainer()
    updateCanvasContext()
    updateFieldArea()

    updateGrid({
      from,
      to,
      context: canvasContext
    });
  }
</script>

<div class="life-container">
  <div class="life-options">
    <div class="field-controls">
      <div class="life-controls">
        <button onclick="startGame()">Start life</button>
        <button onclick="stopGame()">Stop life</button>
      </div>
      <div class="forms-of-life">
        <div>Forms of life:</div>
      </div>
      <div class="field-inputs">
        <div>Field options:</div>
        <div class="field-width-input">
          <label for="field-width">Width (px):</label>
          <input id="field-width" name="field-width" type="number" onkeyup="onWidthChange(this)"/>
          <script>
            const onWidthChange = (input) => {
              widthPx = Number(input.value)
            }
            document.getElementById("field-width").value = widthPx;
          </script>
        </div>
        <div class="field-height-input">
          <label for="field-height">Height (px):</label>
          <input id="field-height" name="field-height" type="number" onkeyup="onHeightChange(this)"/>
          <script>
            const onHeightChange = (input) => {
              heightPx = Number(input.value)
            }
            document.getElementById("field-height").value = heightPx;
          </script>
        </div>
        <div class="cell-size-input">
          <label for="cell-size">Cell (px):</label>
          <input id="cell-size" name="cell-size" type="number" onkeyup="onCellSizeChange(this)"/>
          <script>
            const onCellSizeChange = (input) => {
              cellSizePx = Number(input.value)
            }
            document.getElementById("cell-size").value = cellSizePx;
          </script>
        </div>
        <div class="interval-time-input">
          <label for="interval-time">Interval time (ms):</label>
          <input id="interval-time" name="cell-size" type="number" onkeyup="onIntervalTimeChange(this)"/>
          <script>
            const onIntervalTimeChange = (input) => {
              intervalTime = Number(input.value)
            }
            document.getElementById("interval-time").value = intervalTime;
          </script>
        </div>
        <button onclick="updateField()">Apply field size</button>
      </div>
    </div>

  </div>
  <div class="canvas-wrapper">
    <canvas id="canvas"></canvas>
  </div>
  <div id="scroll-container">
    <div id="field-area"></div>
  </div>
</div>
</body>
</html>
